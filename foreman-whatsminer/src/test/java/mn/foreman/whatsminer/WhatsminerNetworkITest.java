package mn.foreman.whatsminer;

import mn.foreman.util.AbstractAsyncActionITest;
import mn.foreman.util.TestUtils;
import mn.foreman.util.rpc.FakeRpcMinerServer;
import mn.foreman.util.rpc.RpcHandler;

import com.google.common.collect.ImmutableMap;

import java.util.Arrays;

/** Test changing network settings on a Whatsminer. */
public class WhatsminerNetworkITest
        extends AbstractAsyncActionITest {

    /** Constructor. */
    public WhatsminerNetworkITest() {
        super(
                8080,
                4028,
                new WhatsminerNetworkAction(),
                Arrays.asList(
                        () -> new FakeRpcMinerServer(
                                4028,
                                ImmutableMap.of(
                                        "{\"cmd\":\"get_token\"}",
                                        new RpcHandler(
                                                "{\"STATUS\":\"S\",\"When\":1608417125,\"Code\":134,\"Msg\":{\"time\":\"6915\",\"salt\":\"BQ5hoXV9\",\"newsalt\":\"a5TtWui2\"},\"Description\":\"whatsminer v1.1\"}"),
                                        "{\"enc\":1,\"data\":\"kVBW4uRI5N0QfUfzTDyHvom2D4UXJUo8p+GXwEYylLsxf28p9p2B7L3ofKqGXcOecm5lFcrr0CYLZ/59KbFASqwGC5BPsJ2g3ghmV7fIbP4ZZQkFIWxLzz70zbx05FSeKQAnYbPFv3LVHWaCodkuYK102a70W8cJ7jVyFDQ1G1XTQWbmLHxlEVPIZTFKEkfCMcLiHeo/UR8uW2LlMiVRwQ==\"}",
                                        new RpcHandler(
                                                "{\"enc\":\"99J8w83zIqB3/n9c5GlK0Ms8rMLrtR4I9L3mL3ihmpoy4J0v+AHcKtijbyE92q22MIKC6VKEUcYL2KQS50euQWMqSBlxCPx8YYy4oRkOE4C7kjyvgs9rRMH/mhiVH9k+\"}"))),
                        () -> new FakeRpcMinerServer(
                                4029,
                                ImmutableMap.of(
                                        "{\"cmd\":\"summary\"}",
                                        new RpcHandler(
                                                "{\"STATUS\":[{\"STATUS\":\"S\",\"When\":1606349344,\"Code\":11,\"Msg\":\"Summary\",\"Description\":\"cgminer 4.9.2\"}],\"SUMMARY\":[{\"Elapsed\":271950,\"MHS av\":78130188.72,\"MHS 5s\":78398752.21,\"MHS 1m\":78226283.81,\"MHS 5m\":78062260.38,\"MHS 15m\":78035812.17,\"Found Blocks\":0,\"Getworks\":9983,\"Accepted\":57681,\"Rejected\":23,\"Hardware Errors\":9653,\"Utility\":12.73,\"Discarded\":373254,\"Stale\":0,\"Get Failures\":0,\"Local Work\":2771704359,\"Remote Failures\":0,\"Network Blocks\":462,\"Total MH\":21247477854851.0000,\"Work Utility\":17054.14,\"Difficulty Accepted\":4940471970.00000000,\"Difficulty Rejected\":1908584.00000000,\"Difficulty Stale\":0.00000000,\"Best Share\":3846739891,\"Temperature\":70.00,\"freq_avg\":715,\"Fan Speed In\":3330,\"Fan Speed Out\":2760,\"Voltage\":1202,\"Power\":3583,\"Power_RT\":3584,\"Device Hardware%\":0.0125,\"Device Rejected%\":2.4691,\"Pool Rejected%\":0.0386,\"Pool Stale%\":0.0000,\"Last getwork\":0,\"Uptime\":273220,\"Chip Data\":\"HPAP04-20062018 BINV02-193004G\",\"Power Current\":284500,\"Power Fanspeed\":7520,\"Error Code Count\":0,\"Factory Error Code Count\":0,\"Security Mode\":0,\"Liquid Cooling\":false,\"Hash Stable\":true,\"Hash Stable Cost Seconds\":2171,\"Hash Deviation%\":-0.1253,\"Target Freq\":652,\"Target MHS\":71472240,\"Env Temp\":16.00,\"Power Mode\":\"Normal\",\"Firmware Version\":\"'20200722.19.REL'\",\"MAC\":\"C6:06:12:00:BB:AA\",\"Factory GHS\":75993,\"Power Limit\":3600,\"Power Voltage Input\":231.50,\"Power Current Input\":15.58,\"Chip Temp Min\":49.00,\"Chip Temp Max\":94.39,\"Chip Temp Avg\":78.49,\"Debug\":\"14.0_3564_344\"}],\"id\":1}"),
                                        "{\"cmd\":\"edevs\"}",
                                        new RpcHandler(
                                                "{\"STATUS\":[{\"STATUS\":\"S\",\"When\":1606349344,\"Code\":9,\"Msg\":\"3 ASC(s)\",\"Description\":\"cgminer 4.9.2\"}],\"DEVS\":[{\"ASC\":0,\"Name\":\"SM\",\"ID\":0,\"Slot\":0,\"Enabled\":\"Y\",\"Status\":\"Alive\",\"Temperature\":65.50,\"Chip Frequency\":718,\"Fan Speed In\":3330,\"Fan Speed Out\":2760,\"MHS av\":26128368.77,\"MHS 5s\":25432047.72,\"MHS 1m\":26121012.12,\"MHS 5m\":26082216.82,\"MHS 15m\":26075094.58,\"Accepted\":19306,\"Rejected\":5,\"Hardware Errors\":3449,\"Utility\":4.26,\"Last Share Pool\":0,\"Last Share Time\":1606349340,\"Total MH\":7105605360540.0000,\"Diff1 Work\":25850013,\"Difficulty Accepted\":1656092402.00000000,\"Difficulty Rejected\":426521.00000000,\"Last Share Difficulty\":87022.00000000,\"Last Valid Work\":1606349344,\"Device Hardware%\":0.0133,\"Device Rejected%\":1.6500,\"Device Elapsed\":271950,\"Upfreq Complete\":1,\"Effective Chips\":105,\"PCB SN\":\"BAM1FS69630713X30153\",\"Chip Data\":\"HPAP04-20062018 BINV02-193004G\",\"Chip Temp Min\":56.00,\"Chip Temp Max\":86.83,\"Chip Temp Avg\":75.96,\"chip_vol_diff\":14},{\"ASC\":1,\"Name\":\"SM\",\"ID\":1,\"Slot\":1,\"Enabled\":\"Y\",\"Status\":\"Alive\",\"Temperature\":65.50,\"Chip Frequency\":708,\"Fan Speed In\":3330,\"Fan Speed Out\":2760,\"MHS av\":25775347.26,\"MHS 5s\":25589195.43,\"MHS 1m\":25597242.82,\"MHS 5m\":25678145.03,\"MHS 15m\":25720275.43,\"Accepted\":18941,\"Rejected\":7,\"Hardware Errors\":3198,\"Utility\":4.18,\"Last Share Pool\":0,\"Last Share Time\":1606349340,\"Total MH\":7009601228708.0000,\"Diff1 Work\":25500772,\"Difficulty Accepted\":1617996433.00000000,\"Difficulty Rejected\":573971.00000000,\"Last Share Difficulty\":87022.00000000,\"Last Valid Work\":1606349344,\"Device Hardware%\":0.0125,\"Device Rejected%\":2.2508,\"Device Elapsed\":271950,\"Upfreq Complete\":1,\"Effective Chips\":105,\"PCB SN\":\"BAM1FS69630713X30150\",\"Chip Data\":\"HPAP04-20062018 BINV02-193004G\",\"Chip Temp Min\":56.00,\"Chip Temp Max\":85.67,\"Chip Temp Avg\":75.17,\"chip_vol_diff\":13},{\"ASC\":2,\"Name\":\"SM\",\"ID\":2,\"Slot\":2,\"Enabled\":\"Y\",\"Status\":\"Alive\",\"Temperature\":70.00,\"Chip Frequency\":719,\"Fan Speed In\":3330,\"Fan Speed Out\":2760,\"MHS av\":26226459.61,\"MHS 5s\":26729036.38,\"MHS 1m\":26446959.21,\"MHS 5m\":26290334.58,\"MHS 15m\":26236481.74,\"Accepted\":19434,\"Rejected\":11,\"Hardware Errors\":3006,\"Utility\":4.29,\"Last Share Pool\":0,\"Last Share Time\":1606349335,\"Total MH\":7132281161207.0000,\"Diff1 Work\":25947054,\"Difficulty Accepted\":1666383135.00000000,\"Difficulty Rejected\":908092.00000000,\"Last Share Difficulty\":87022.00000000,\"Last Valid Work\":1606349344,\"Device Hardware%\":0.0116,\"Device Rejected%\":3.4998,\"Device Elapsed\":271950,\"Upfreq Complete\":1,\"Effective Chips\":105,\"PCB SN\":\"B5M1FS69630717K31306\",\"Chip Data\":\"HP5A04-20070734 BINV02-193004G\",\"Chip Temp Min\":49.00,\"Chip Temp Max\":94.39,\"Chip Temp Avg\":84.34,\"chip_vol_diff\":14}],\"id\":1}"),
                                        "{\"cmd\":\"pools\"}",
                                        new RpcHandler(
                                                "{\"STATUS\":[{\"STATUS\":\"S\",\"When\":1606349344,\"Code\":7,\"Msg\":\"3 Pool(s)\",\"Description\":\"cgminer 4.9.2\"}],\"POOLS\":[{\"POOL\":0,\"URL\":\"stratum+tcp://ru-west.stratum.slushpool.com:3333\",\"Status\":\"Alive\",\"Priority\":0,\"Quota\":1,\"Long Poll\":\"N\",\"Getworks\":9983,\"Accepted\":57681,\"Rejected\":23,\"Works\":-1520006932,\"Discarded\":373254,\"Stale\":0,\"Get Failures\":0,\"Remote Failures\":0,\"User\":\"xxx\",\"Last Share Time\":1606349340,\"Diff1 Shares\":77297833,\"Proxy Type\":\"\",\"Proxy\":\"\",\"Difficulty Accepted\":4940471970.00000000,\"Difficulty Rejected\":1908584.00000000,\"Difficulty Stale\":0.00000000,\"Last Share Difficulty\":87022.00000000,\"Work Difficulty\":0.00000000,\"Has Stratum\":true,\"Stratum Active\":true,\"Stratum URL\":\"ru-west.stratum.slushpool.com\",\"Stratum Difficulty\":87022.00000000,\"Has GBT\":false,\"Best Share\":3846739891,\"Pool Rejected%\":0.0386,\"Pool Stale%\":0.0000,\"Bad Work\":462,\"Current Block Height\":658678,\"Current Block Version\":536870912},{\"POOL\":1,\"URL\":\"stratum+tcp://eu.stratum.slushpool.com:3333\",\"Status\":\"Alive\",\"Priority\":1,\"Quota\":1,\"Long Poll\":\"N\",\"Getworks\":0,\"Accepted\":0,\"Rejected\":0,\"Works\":0,\"Discarded\":0,\"Stale\":0,\"Get Failures\":0,\"Remote Failures\":0,\"User\":\"xxx\",\"Last Share Time\":0,\"Diff1 Shares\":0,\"Proxy Type\":\"\",\"Proxy\":\"\",\"Difficulty Accepted\":0.00000000,\"Difficulty Rejected\":0.00000000,\"Difficulty Stale\":0.00000000,\"Last Share Difficulty\":0.00000000,\"Work Difficulty\":0.00000000,\"Has Stratum\":true,\"Stratum Active\":false,\"Stratum URL\":\"\",\"Stratum Difficulty\":0.00000000,\"Has GBT\":false,\"Best Share\":0,\"Pool Rejected%\":0.0000,\"Pool Stale%\":0.0000,\"Bad Work\":0,\"Current Block Height\":0,\"Current Block Version\":536870912},{\"POOL\":2,\"URL\":\"stratum+tcp://eu.stratum.slushpool.com:3333\",\"Status\":\"Alive\",\"Priority\":2,\"Quota\":1,\"Long Poll\":\"N\",\"Getworks\":0,\"Accepted\":0,\"Rejected\":0,\"Works\":0,\"Discarded\":0,\"Stale\":0,\"Get Failures\":0,\"Remote Failures\":0,\"User\":\"xxx\",\"Last Share Time\":0,\"Diff1 Shares\":0,\"Proxy Type\":\"\",\"Proxy\":\"\",\"Difficulty Accepted\":0.00000000,\"Difficulty Rejected\":0.00000000,\"Difficulty Stale\":0.00000000,\"Last Share Difficulty\":0.00000000,\"Work Difficulty\":0.00000000,\"Has Stratum\":true,\"Stratum Active\":false,\"Stratum URL\":\"\",\"Stratum Difficulty\":0.00000000,\"Has GBT\":false,\"Best Share\":0,\"Pool Rejected%\":0.0000,\"Pool Stale%\":0.0000,\"Bad Work\":0,\"Current Block Height\":0,\"Current Block Version\":536870912}],\"id\":1}")))),
                new WhatsminerFactory(),
                TestUtils.toNetworkJson(4029, false),
                true);
    }
}
